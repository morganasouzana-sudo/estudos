<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Estudos SEBRAE 2026 - Repeti√ß√£o Espa√ßada</title>
    <style>
        :root {
            --primary: #005DAA; --primary-dark: #004580; --secondary: #FFD200;
            --text: #333; --text-light: #666; --bg: #f0f2f5; --card-bg: #ffffff;
            --success: #28a745; --error: #dc3545; --border-radius: 12px;
            --shadow: 0 4px 15px rgba(0,0,0,0.08);
        }
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; -webkit-tap-highlight-color: transparent; }
        
        body { 
            background-color: var(--bg); color: var(--text); 
            min-height: 100vh; display: flex; justify-content: center; align-items: center; 
            padding: 20px; 
        }
        
        .container { 
            width: 100%; max-width: 900px; 
            background: var(--card-bg); border-radius: var(--border-radius); 
            box-shadow: var(--shadow); overflow: hidden; 
            min-height: 600px; display: flex; flex-direction: column; position: relative; 
        }
        
        /* Header */
        header { 
            background: var(--primary); color: white; padding: 15px 20px; 
            display: flex; justify-content: space-between; align-items: center; 
            flex-wrap: wrap; gap: 10px;
        }
        h1 { font-size: 1.1rem; font-weight: 600; margin: 0; white-space: nowrap; }
        .subtitle { font-size: 0.8rem; opacity: 0.9; display: block; margin-top: 2px; }
        .badge { background: rgba(255,255,255,0.2); padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; white-space: nowrap; }
        
        /* Screens */
        .screen { display: none; flex-direction: column; flex: 1; padding: 20px; animation: fadeIn 0.3s ease; overflow-y: auto; }
        .screen.active { display: flex; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Buttons & Inputs */
        button { 
            padding: 12px 20px; border-radius: 8px; border: none; font-size: 1rem; 
            cursor: pointer; transition: 0.2s; font-weight: 600; width: 100%; 
            touch-action: manipulation;
        }
        button.primary { background: var(--primary); color: white; }
        button.primary:hover { background: var(--primary-dark); }
        button.secondary { background: transparent; border: 2px solid #ddd; color: #666; }
        button.secondary:hover { border-color: var(--primary); color: var(--primary); background: #f9f9f9; }
        
        select, input[type="text"] { 
            padding: 12px; border-radius: 8px; border: 1px solid #ccc; width: 100%; 
            font-size: 1rem; margin-bottom: 15px; background: white; 
        }
        
        /* Login Screen */
        .login-box { text-align: center; max-width: 400px; margin: 0 auto; padding-top: 20px; width: 100%; }
        .user-list { display: flex; flex-direction: column; gap: 10px; margin-top: 20px; max-height: 300px; overflow-y: auto; }
        .user-card { 
            background: #fff; border: 1px solid #eee; padding: 15px; border-radius: 8px; 
            display: flex; justify-content: space-between; align-items: center; 
            cursor: pointer; transition: 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.02);
        }
        .user-card:hover { border-color: var(--primary); transform: translateY(-1px); box-shadow: 0 4px 8px rgba(0,0,0,0.05); }
        .delete-user { color: #ccc; font-size: 1.2rem; padding: 0 10px; cursor: pointer; transition: 0.2s; }
        .delete-user:hover { color: var(--error); }

        /* Setup Area */
        .setup-box { border: 2px dashed #ccc; padding: 30px 20px; text-align: center; border-radius: 12px; margin: 15px 0; cursor: pointer; transition: 0.2s; }
        .setup-box:hover { border-color: var(--primary); background: #f9f9f9; }
        .file-status-list { max-height: 150px; overflow-y: auto; margin-top: 15px; text-align: left; font-size: 0.85rem; border: 1px solid #eee; padding: 10px; border-radius: 8px; background: #fafafa; display: none; }
        .status-item { display: flex; justify-content: space-between; margin-bottom: 5px; border-bottom: 1px solid #eee; padding-bottom: 4px; }
        
        /* Home Stats */
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 20px; }
        .stat-card { background: #f8f9fa; padding: 15px 10px; border-radius: 8px; text-align: center; border: 1px solid #eee; }
        .stat-value { font-size: 1.5rem; font-weight: bold; color: var(--primary); display: block; margin-bottom: 5px; }
        .stat-label { font-size: 0.70rem; color: #777; text-transform: uppercase; letter-spacing: 0.5px; }
        
        /* Mode Toggle */
        .mode-toggle { display: flex; background: #eee; padding: 4px; border-radius: 10px; margin-bottom: 20px; }
        .mode-btn { flex: 1; background: transparent; color: #666; border-radius: 8px; padding: 8px; border: none; font-size: 0.9rem; }
        .mode-btn.selected { background: white; color: var(--primary); box-shadow: 0 2px 4px rgba(0,0,0,0.1); font-weight: bold; }
        
        /* Quiz Layout */
        .question-meta { display: flex; justify-content: space-between; margin-bottom: 15px; color: #777; font-size: 0.85rem; }
        .question-text { font-size: 1.1rem; line-height: 1.5; margin-bottom: 20px; font-weight: 500; }
        .options { display: flex; flex-direction: column; gap: 10px; }
        .opt-btn { 
            text-align: left; background: white; border: 1px solid #ddd; color: #444; 
            padding: 15px; border-radius: 8px; transition: 0.2s; position: relative; font-size: 0.95rem;
        }
        .opt-btn:active { background: #f0f0f0; }
        .opt-btn.correct { background: #d4edda; border-color: var(--success); color: #155724; }
        .opt-btn.wrong { background: #f8d7da; border-color: var(--error); color: #721c24; }
        
        /* Discursive Inputs */
        .discursive-input { width: 100%; padding: 15px; border-radius: 8px; border: 1px solid #ccc; font-size: 1rem; margin-bottom: 15px; resize: vertical; font-family: inherit; background: #fff; box-shadow: inset 0 2px 4px rgba(0,0,0,0.05); }
        .discursive-input:focus { outline: none; border-color: var(--primary); box-shadow: inset 0 2px 4px rgba(0,0,0,0.05), 0 0 0 3px rgba(0,93,170,0.2); }
        .self-assess-box { margin-top: 20px; padding: 15px; background: #fff3cd; border: 1px solid #ffeeba; border-radius: 8px; text-align: center; }
        .self-assess-buttons { display: flex; gap: 10px; margin-top: 10px; justify-content: center; }
        .self-assess-buttons button { width: auto; padding: 10px 20px; }

        .feedback { 
            margin-top: 20px; padding: 15px; background: #eef5fa; 
            border-left: 4px solid var(--primary); border-radius: 4px; display: none; font-size: 0.95rem;
        }
        .feedback h4 { color: var(--primary); margin: 0 0 5px 0; font-size: 1rem; }
        
        /* Flashcards */
        .fc-container { flex: 1; display: flex; justify-content: center; align-items: center; perspective: 1000px; margin: 10px 0; cursor: pointer; min-height: 250px; }
        .flashcard { width: 100%; max-width: 500px; height: 100%; min-height: 280px; position: relative; transform-style: preserve-3d; transition: transform 0.6s; }
        .flashcard.flipped { transform: rotateY(180deg); }
        .fc-face { 
            position: absolute; width: 100%; height: 100%; backface-visibility: hidden; 
            border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.05); 
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
            padding: 20px; text-align: center; border: 1px solid #eee; background: white; 
        }
        .fc-front { background: white; }
        .fc-back { background: var(--primary); color: white; transform: rotateY(180deg); }
        .fc-content { font-size: 1.2rem; font-weight: 500; overflow-y: auto; max-height: 100%; width: 100%; }
        .fc-hint { margin-top: 15px; font-size: 0.8rem; opacity: 0.6; }
        
        /* Footer Controls */
        .footer { margin-top: auto; display: flex; gap: 10px; padding-top: 20px; }
        
        /* Loader */
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin: 0 auto; display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Mobile Adjustments */
        @media (max-width: 600px) { 
            body { padding: 0; align-items: flex-start; background: #fff; }
            .container { border-radius: 0; box-shadow: none; min-height: 100vh; }
            header { padding: 15px; position: sticky; top: 0; z-index: 10; }
            h1 { font-size: 1rem; }
            .screen { padding: 15px; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); gap: 8px; }
            .stat-value { font-size: 1.2rem; }
            .question-text { font-size: 1rem; }
            .opt-btn { padding: 12px; font-size: 0.9rem; }
            .flashcard { min-height: 220px; }
            .fc-content { font-size: 1.1rem; }
        }
    </style>
</head>
<body>

<div class="container" id="app">
    <header>
        <div style="flex: 1;">
            <h1>Estudos SEBRAE</h1>
            <span class="subtitle">Analista T√©cnico I - Projetos</span>
        </div>
        <div style="display:flex; align-items:center; gap:8px;">
            <span class="badge" id="user-display" style="display:none; background: var(--secondary); color:#333; font-weight:600;">Visitante</span>
            <span class="badge" id="header-status" style="opacity: 0.8;">Login</span>
        </div>
    </header>

    <!-- TELA -1: LOGIN (NOVA) -->
    <div id="screen-login" class="screen active">
        <div class="login-box">
            <h2 style="color: var(--primary);">Bem-vindo</h2>
            <p style="color: #666; margin-bottom: 25px; font-size: 0.9rem;">Selecione seu perfil para continuar.</p>
            
            <div style="display: flex; gap: 8px; margin-bottom: 25px;">
                <input type="text" id="new-user-name" placeholder="Novo usu√°rio..." onkeypress="if(event.key === 'Enter') app.createUser()">
                <button class="primary" onclick="app.createUser()" style="width: auto; padding: 0 20px;">+</button>
            </div>

            <div id="user-list" class="user-list">
                <!-- Lista preenchida via JS -->
            </div>
        </div>
    </div>

    <!-- TELA 0: SETUP -->
    <div id="screen-setup" class="screen">
        <div style="text-align: center; margin-top: 20px;">
            <h2>Carregar Conte√∫do</h2>
            <p style="color: #666; font-size: 0.9rem;">O sistema est√° procurando os arquivos na pasta...</p>
        </div>

        <div class="setup-box" style="border: none;">
            <div id="loader-github" class="loader"></div>
            <p id="loading-text" style="margin-top: 15px; color: #888; font-size: 0.9rem;">Verificando arquivos...</p>
        </div>
        
        <div id="file-status-list" class="file-status-list" style="display: block;"></div>

        <div style="margin-top: 30px; text-align: center;">
            <p style="font-size: 0.85rem; color: #888;">Falha no autom√°tico? Tente manual:</p>
            <button class="secondary" onclick="document.getElementById('file-input').click()">üìÇ Selecionar Arquivos</button>
            <input type="file" id="file-input" multiple accept=".json" style="display: none;" onchange="app.handleFileUpload(this.files)">
            <br><br>
            <button class="secondary" onclick="app.useEmbeddedData()" style="font-size: 0.8rem; border: none; color: #999;">
                Usar Base Offline (Emerg√™ncia)
            </button>
        </div>
        
        <button class="secondary" onclick="app.logout()" style="margin-top: 20px; color: var(--error); border-color: #eee;">
            Sair
        </button>
    </div>

    <!-- TELA 1: HOME -->
    <div id="screen-home" class="screen">
        <div class="stats-grid">
            <div class="stat-card">
                <span class="stat-value" id="st-total">0</span>
                <span class="stat-label">Feitas</span>
            </div>
            <div class="stat-card">
                <span class="stat-value" id="st-score">0%</span>
                <span class="stat-label">Acerto</span>
            </div>
            <div class="stat-card">
                <span class="stat-value" id="st-db-size">0</span>
                <span class="stat-label">Total Banco</span>
            </div>
            <div class="stat-card" style="background: #eef6fc; border-color: var(--primary);">
                <span class="stat-value" id="st-reviews">0</span>
                <span class="stat-label" style="color: var(--primary); font-weight: bold;">P/ Revisar</span>
            </div>
        </div>

        <button class="primary" id="btn-review-session" onclick="app.startReviewSession()" style="margin-bottom: 20px; display: none; background: #28a745;">
            üîÑ Fazer Revis√µes Pendentes
        </button>

        <div class="mode-toggle">
            <button class="mode-btn selected" onclick="app.setMode('quiz')">üìù Quiz Geral</button>
            <button class="mode-btn" onclick="app.setMode('flashcard')">üîÑ Flashcards</button>
        </div>

        <label style="font-weight: 600; font-size: 0.9rem; margin-bottom: 5px; display: block; color: #555;">Filtrar por Disciplina (Modo Geral):</label>
        <select id="sel-subject">
            <option value="all">Todas as Disciplinas</option>
        </select>

        <div style="flex: 1;"></div>

        <button class="primary" onclick="app.startSession()" style="margin-bottom: 10px;">INICIAR ESTUDOS (NOVAS)</button>
        
        <div style="display: flex; gap: 10px;">
            <button class="secondary" onclick="app.resetStats()">Zerar Progresso</button>
            <button class="secondary" onclick="app.logout()" style="border-color: #eee; color: var(--error);">Sair</button>
        </div>
    </div>

    <!-- TELA 2: QUIZ -->
    <div id="screen-quiz" class="screen">
        <div class="progress-bar"><div class="progress-fill" id="quiz-progress"></div></div>
        
        <div class="question-meta">
            <span id="q-topic">Tema</span>
            <span id="q-counter">1/10</span>
        </div>
        
        <div class="question-text" id="q-text">Carregando...</div>
        
        <!-- √Årea para M√∫ltipla Escolha -->
        <div class="options" id="q-options"></div>

        <!-- √Årea para Discursiva -->
        <div id="q-discursive-area" style="display: none; background: #f8f9fa; padding: 20px; border-radius: 8px; border: 1px solid #e0e0e0; margin-bottom: 20px;">
            <p style="margin-bottom: 10px; font-weight: 600; color: var(--primary);">üìù Quest√£o Discursiva</p>
            <p style="font-size: 0.9rem; color: #666; margin-bottom: 15px;">Utilize o espa√ßo abaixo para estruturar a sua resposta antes de verificar o gabarito.</p>
            <textarea id="discursive-input" class="discursive-input" rows="6" placeholder="Digite aqui a sua resposta ou t√≥picos do seu racioc√≠nio..."></textarea>
            <button class="primary" id="btn-verify-disc" onclick="app.checkDiscursive()">Verificar Gabarito</button>
        </div>

        <!-- Feedback e Autoavalia√ß√£o -->
        <div class="feedback" id="q-feedback">
            <h4 id="fb-title">Explica√ß√£o</h4>
            <p id="fb-text">...</p>
            
            <div id="q-self-assess" class="self-assess-box" style="display: none;">
                <p style="margin-bottom: 10px; font-weight: 600; color: #856404;">A sua resposta escrita contemplou os principais pontos do gabarito oficial?</p>
                <div class="self-assess-buttons">
                    <button class="opt-btn correct" onclick="app.answerDiscursive(true)">‚úÖ Sim, Acertei</button>
                    <button class="opt-btn wrong" onclick="app.answerDiscursive(false)">‚ùå N√£o, Errei</button>
                </div>
            </div>
        </div>

        <div class="footer">
            <button class="secondary" onclick="app.goHome()">Parar</button>
            <button class="primary" id="btn-next-q" onclick="app.nextQuestion()" style="display: none;">Pr√≥xima ‚û°</button>
        </div>
    </div>

    <!-- TELA 3: FLASHCARDS -->
    <div id="screen-flashcard" class="screen">
        <div class="question-meta" style="justify-content: center;">
            <span id="fc-counter">1 / 10</span>
        </div>
        <div class="fc-container">
            <div class="flashcard" onclick="this.classList.toggle('flipped')">
                <div class="fc-face fc-front">
                    <div class="fc-content" id="fc-front">Frente</div>
                    <div class="fc-hint">Toque para virar</div>
                </div>
                <div class="fc-face fc-back">
                    <div class="fc-content" id="fc-back">Verso</div>
                </div>
            </div>
        </div>
        <div class="footer">
            <button class="secondary" onclick="app.goHome()">Encerrar</button>
            <button class="primary" onclick="app.nextFlashcard()">Pr√≥ximo ‚û°</button>
        </div>
    </div>
</div>

<script>
// --- LISTA DE ARQUIVOS PARA BUSCAR ---
const PART_FILES = [
    'simulado_parte1.json', 'simulado_parte2.json', 'simulado_parte3.json',
    'simulado_parte4.json', 'simulado_parte5.json', 'simulado_parte6.json', 'simulado_parte7.json'
];

// --- FALLBACK (EMBEDDED) ---
const EMBEDDED_DB = {
  "questoes": [
    {"id":1,"tema":"Gest√£o de Projetos","tipo":"multipla_escolha","enunciado":"(Fallback) No PMI, o documento que autoriza formalmente o projeto √©:","alternativas":["EAP","Termo de Abertura","Plano","Escopo"],"correta":1,"explicacao":"O Termo de Abertura (TAP) oficializa o projeto."},
    {"id":2,"tema":"Gest√£o de Projetos","tipo":"discursiva","enunciado":"(Fallback Discursiva) O que √© e para que serve o TAP (Termo de Abertura do Projeto)?","alternativas":[],"correta":0,"explicacao":"O TAP √© o documento emitido pelo patrocinador que autoriza formalmente a exist√™ncia do projeto e d√° autoridade ao gerente de projetos."}
  ],
  "flashcards": [
    {"frente":"(Fallback) Prazo Cadastro Contrato","verso":"Imediatamente"}
  ]
};

const app = {
    data: { questoes: [], flashcards: [] },
    state: { mode: 'quiz', currentItems: [], index: 0, score: 0, answered: false, currentUser: null, reviews: {}, isReviewSession: false },
    subjectMapping: {}, 
    
    init() { 
        const activeUser = localStorage.getItem('sebrae_active_session');
        if (activeUser) {
            this.login(activeUser, true);
        } else {
            this.renderUserList(); 
        }
    },

    // --- GEST√ÉO DE UTILIZADORES ---
    getUsers() {
        return JSON.parse(localStorage.getItem('sebrae_users') || '[]');
    },

    createUser() {
        const nameInput = document.getElementById('new-user-name');
        const name = nameInput.value.trim();
        if (!name) return;

        const users = this.getUsers();
        if (users.includes(name)) {
            alert("Utilizador j√° existe!");
            return;
        }

        users.push(name);
        localStorage.setItem('sebrae_users', JSON.stringify(users));
        nameInput.value = '';
        this.renderUserList();
    },

    deleteUser(e, name) {
        e.stopPropagation();
        if(!confirm(`Apagar progresso de ${name}?`)) return;
        
        let users = this.getUsers();
        users = users.filter(u => u !== name);
        localStorage.setItem('sebrae_users', JSON.stringify(users));
        localStorage.removeItem(`sebrae_stats_${name}`); 
        localStorage.removeItem(`sebrae_rev_${name}`); 
        
        if (this.state.currentUser === name) this.logout();
        else this.renderUserList();
    },

    login(name, isAuto = false) {
        this.state.currentUser = name;
        localStorage.setItem('sebrae_active_session', name); 
        
        document.getElementById('user-display').innerText = name;
        document.getElementById('user-display').style.display = 'inline-block';
        
        if (!isAuto && this.data.questoes.length > 0) {
            this.loadStats(); 
            this.showScreen('screen-home');
        } else {
            this.showScreen('screen-setup');
            this.loadPartsFromRepo(); 
        }
    },

    logout() {
        this.state.currentUser = null;
        localStorage.removeItem('sebrae_active_session'); 
        document.getElementById('user-display').style.display = 'none';
        this.renderUserList(); 
        this.showScreen('screen-login');
    },

    renderUserList() {
        const list = document.getElementById('user-list');
        list.innerHTML = '';
        const users = this.getUsers();

        if (users.length === 0) {
            list.innerHTML = '<div style="color:#999; font-style:italic; font-size:0.9rem;">Nenhum utilizador criado.</div>';
            return;
        }

        users.forEach(u => {
            const div = document.createElement('div');
            div.className = 'user-card';
            div.onclick = () => this.login(u);
            div.innerHTML = `
                <span>üë§ ${u}</span>
                <span class="delete-user" onclick="app.deleteUser(event, '${u}')">√ó</span>
            `;
            list.appendChild(div);
        });
    },

    // --- CARREGAMENTO DE ARQUIVOS ---
    async loadPartsFromRepo() {
        const loader = document.getElementById('loader-github');
        const statusList = document.getElementById('file-status-list');
        const loadingText = document.getElementById('loading-text');
        
        loader.style.display = 'block';
        statusList.innerHTML = ''; 
        loadingText.innerText = "Buscando arquivos na pasta...";
        
        let loadedQ = [];
        let loadedF = [];
        let successCount = 0;

        const promises = PART_FILES.map(filename => 
            fetch(filename)
                .then(res => {
                    if (!res.ok) throw new Error('404');
                    return res.json();
                })
                .then(json => {
                    if(json.questoes) loadedQ = loadedQ.concat(json.questoes);
                    if(json.flashcards) loadedF = loadedF.concat(json.flashcards);
                    statusList.innerHTML += `<div class="status-item"><span>${filename}</span><span style="color:green">‚úî</span></div>`;
                    successCount++;
                })
                .catch(err => {
                    console.log(`Arquivo ${filename} n√£o encontrado.`);
                })
        );

        await Promise.all(promises);
        loader.style.display = 'none';

        if (successCount > 0) {
            this.data.questoes = loadedQ;
            this.data.flashcards = loadedF;
            
            loadingText.innerText = "Carregamento conclu√≠do!";
            loadingText.style.color = "green";
            
            setTimeout(() => { this.prepareData(); }, 500);
        } else {
            loadingText.innerText = "Nenhum arquivo encontrado. Use o upload manual.";
            loadingText.style.color = "#d9534f";
        }
    },

    handleFileUpload(files) {
        if (files.length === 0) return;
        let loadedQ = [];
        let loadedF = [];
        let filesRead = 0;

        Array.from(files).forEach(file => {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const json = JSON.parse(e.target.result);
                    if(json.questoes) loadedQ = loadedQ.concat(json.questoes);
                    if(json.flashcards) loadedF = loadedF.concat(json.flashcards);
                } catch (err) { console.error("Erro no arquivo " + file.name); } 
                finally {
                    filesRead++;
                    if(filesRead === files.length) {
                        this.data.questoes = loadedQ;
                        this.data.flashcards = loadedF;
                        this.prepareData();
                    }
                }
            };
            reader.readAsText(file);
        });
    },

    useEmbeddedData() {
        this.data.questoes = EMBEDDED_DB.questoes;
        this.data.flashcards = EMBEDDED_DB.flashcards;
        this.prepareData();
    },

    prepareData() {
        document.getElementById('st-db-size').innerText = this.data.questoes.length + this.data.flashcards.length;
        this.loadStats(); 
        this.loadReviews();
        
        const mapping = {};
        const getCategory = (fullTheme) => {
            if (!fullTheme) return "Geral";
            const t = fullTheme.toUpperCase();
            if (t.includes("IN 07") || t.includes("FINANCEIRO")) return "Gest√£o Financeira (IN 07)";
            if (t.includes("IN 36") || t.includes("CONTRATA√á√ïES")) return "Contrata√ß√µes (IN 36)";
            if (t.includes("IN 51") || t.includes("GEST√ÉO DE CONTRATOS")) return "Gest√£o de Contratos (IN 51)";
            if (t.includes("IN 41") || t.includes("PARCERIAS") || t.includes("CONV√äNIO")) return "Conv√™nios e Parcerias (Manual/IN 41)";
            if (t.includes("LICITA√á") || t.includes("RES 493")) return "Licita√ß√µes (Res. 493)";
            if (t.includes("AGRO") || t.includes("RURAL")) return "Agroneg√≥cio e Certifica√ß√µes";
            if (t.includes("PROJETO") || t.includes("PMI") || t.includes("√ÅGIL")) return "Gest√£o de Projetos";
            if (t.includes("PORTUGU√äS") || t.includes("L√çNGUA")) return "L√≠ngua Portuguesa";
            if (t.includes("SEBRAE") || t.includes("ESG") || t.includes("LGPD")) return "Conhecimentos Gerais Sebrae";
            return "Outros Temas"; 
        };

        this.data.questoes.forEach(q => {
            const cat = getCategory(q.tema);
            if (!mapping[cat]) mapping[cat] = [];
            if (!mapping[cat].includes(q.tema)) mapping[cat].push(q.tema);
        });

        this.subjectMapping = mapping; 

        const sel = document.getElementById('sel-subject');
        sel.innerHTML = '<option value="all">Todas as Disciplinas</option>';
        Object.keys(mapping).sort().forEach(cat => {
            const opt = document.createElement('option');
            opt.value = cat; 
            opt.innerText = cat;
            sel.appendChild(opt);
        });

        this.updateStatsUI();
        this.showScreen('screen-home');
    },

    // --- REPETI√á√ÉO ESPA√áADA (REVIS√ïES) ---
    loadReviews() {
        if(!this.state.currentUser) return;
        this.state.reviews = JSON.parse(localStorage.getItem(`sebrae_rev_${this.state.currentUser}`) || '{}');
    },

    saveReviews() {
        if(!this.state.currentUser) return;
        localStorage.setItem(`sebrae_rev_${this.state.currentUser}`, JSON.stringify(this.state.reviews));
    },

    getPendingReviews() {
        let now = Date.now();
        let pendingIds = [];
        for(let id in this.state.reviews) {
            if(this.state.reviews[id].nextDate <= now) {
                pendingIds.push(parseInt(id));
            }
        }
        return pendingIds;
    },

    updateReviewLogic(qId, isCorrect) {
        let now = Date.now();
        let rev = this.state.reviews[qId];

        if (!isCorrect) {
            // Errou: marca para 24h
            this.state.reviews[qId] = { step: 1, nextDate: now + (24 * 60 * 60 * 1000) };
        } else if (rev) {
            // Acertou na revis√£o (move para a pr√≥xima etapa ou conclui)
            if (rev.step === 1) {
                this.state.reviews[qId] = { step: 2, nextDate: now + (72 * 60 * 60 * 1000) }; // 72h
            } else if (rev.step === 2) {
                this.state.reviews[qId] = { step: 3, nextDate: now + (7 * 24 * 60 * 60 * 1000) }; // 1 semana
            } else {
                delete this.state.reviews[qId]; // Terminadas as 3 revis√µes
            }
        }
        this.saveReviews();
    },

    startReviewSession() {
        let pendingIds = this.getPendingReviews();
        if(pendingIds.length === 0) return;
        
        this.state.mode = 'quiz'; 
        this.state.isReviewSession = true;
        
        let items = this.data.questoes.filter(q => pendingIds.includes(q.id));
        
        this.state.currentItems = items.sort(() => Math.random() - 0.5);
        this.state.index = 0;
        this.state.score = 0;
        this.state.answered = false;

        this.showScreen('screen-quiz');
        this.renderQuiz();
    },

    // --- L√ìGICA DE ESTUDO (GERAL) ---
    setMode(mode) {
        this.state.mode = mode;
        document.querySelectorAll('.mode-btn').forEach(b => b.classList.remove('selected'));
        const idx = mode === 'quiz' ? 0 : 1;
        document.querySelectorAll('.mode-btn')[idx].classList.add('selected');
    },

    startSession() {
        this.state.isReviewSession = false;
        const mode = this.state.mode;
        const subj = document.getElementById('sel-subject').value;
        let items = mode === 'quiz' ? this.data.questoes : this.data.flashcards;

        if (mode === 'quiz' && subj !== 'all') {
            const allowedThemes = this.subjectMapping[subj] || [];
            items = items.filter(i => allowedThemes.includes(i.tema));
        }

        if (items.length === 0) { alert("Sem itens para este filtro."); return; }

        this.state.currentItems = items.sort(() => Math.random() - 0.5);
        this.state.index = 0;
        this.state.score = 0;
        this.state.answered = false;

        this.showScreen(mode === 'quiz' ? 'screen-quiz' : 'screen-flashcard');
        mode === 'quiz' ? this.renderQuiz() : this.renderFlashcard();
    },

    // --- QUIZ & DISCURSIVAS ---
    renderQuiz() {
        const q = this.state.currentItems[this.state.index];
        const total = this.state.currentItems.length;
        
        // Header infos
        let preTitle = this.state.isReviewSession ? "[REVIS√ÉO] " : "";
        document.getElementById('q-topic').innerText = preTitle + (q.tema || 'Geral');
        document.getElementById('q-counter').innerText = `${this.state.index + 1}/${total}`;
        document.getElementById('q-text').innerText = q.enunciado;
        
        // Progress Bar
        const pct = ((this.state.index) / total) * 100;
        document.getElementById('quiz-progress').style.width = pct + '%';
        
        // Elements
        const optsDiv = document.getElementById('q-options');
        const discArea = document.getElementById('q-discursive-area');
        const feedbackArea = document.getElementById('q-feedback');
        const selfAssess = document.getElementById('q-self-assess');
        const btnNext = document.getElementById('btn-next-q');
        
        // Reset state
        optsDiv.innerHTML = '';
        feedbackArea.style.display = 'none';
        selfAssess.style.display = 'none';
        btnNext.style.display = 'none';
        this.state.answered = false;

        // Reabilitar bot√µes discursivos caso tenham sido desativados no passo anterior
        document.querySelectorAll('#q-self-assess .opt-btn').forEach(b => b.disabled = false);

        // Render baseado no tipo
        if (q.tipo === 'discursiva') {
            optsDiv.style.display = 'none';
            discArea.style.display = 'block';
            document.getElementById('discursive-input').value = '';
            document.getElementById('btn-verify-disc').style.display = 'block';
        } else {
            discArea.style.display = 'none';
            optsDiv.style.display = 'flex';
            
            q.alternativas.forEach((alt, idx) => {
                const btn = document.createElement('button');
                btn.className = 'opt-btn';
                btn.innerText = alt;
                btn.onclick = () => this.answerMC(idx, btn, q.correta, q.explicacao);
                optsDiv.appendChild(btn);
            });
        }
    },

    // Resposta M√∫ltipla Escolha
    answerMC(idx, btn, correctIdx, explanation) {
        if (this.state.answered) return;
        this.state.answered = true;

        let isCorrect = (idx === correctIdx);
        // Aplica o disabled apenas nos bot√µes de m√∫ltipla escolha para n√£o quebrar a discursiva
        const allBtns = document.querySelectorAll('#q-options .opt-btn');
        allBtns[correctIdx].classList.add('correct');

        if (isCorrect) {
            this.state.score++;
        } else {
            btn.classList.add('wrong');
        }
        
        allBtns.forEach(b => b.disabled = true);
        this.handlePostAnswer(isCorrect, explanation);
    },

    // Fluxo Discursiva (Verificar)
    checkDiscursive() {
        if(!document.getElementById('discursive-input').value.trim()) {
            if(!confirm("Voc√™ n√£o digitou nada. Deseja ver o gabarito mesmo assim?")) return;
        }
        document.getElementById('btn-verify-disc').style.display = 'none';
        
        const q = this.state.currentItems[this.state.index];
        
        document.getElementById('fb-title').innerText = "Gabarito Oficial";
        document.getElementById('fb-title').style.color = "var(--primary)";
        document.getElementById('fb-text').innerText = q.explicacao;
        
        document.getElementById('q-feedback').style.display = 'block';
        document.getElementById('q-self-assess').style.display = 'block';
    },

    // Fluxo Discursiva (Autoavalia√ß√£o)
    answerDiscursive(isCorrect) {
        if (this.state.answered) return;
        this.state.answered = true;

        document.getElementById('q-self-assess').style.display = 'none';
        if (isCorrect) this.state.score++;

        const q = this.state.currentItems[this.state.index];
        this.handlePostAnswer(isCorrect, q.explicacao);
    },

    // Processamento p√≥s resposta (Comum para MC e Discursiva)
    handlePostAnswer(isCorrect, explanation) {
        const q = this.state.currentItems[this.state.index];
        
        // Feedback Visual
        const title = document.getElementById('fb-title');
        title.innerText = isCorrect ? "Correto!" : "Incorreto";
        title.style.color = isCorrect ? "var(--success)" : "var(--error)";
        document.getElementById('fb-text').innerText = explanation;
        
        document.getElementById('q-feedback').style.display = 'block';
        document.getElementById('btn-next-q').style.display = 'block';

        // L√≥gica de Repeti√ß√£o Espa√ßada
        this.updateReviewLogic(q.id, isCorrect);

        // Atualiza estat√≠sticas globais em TEMPO REAL (Garante que clicar em 'Parar' n√£o perde o progresso)
        if (this.state.currentUser) {
            const userKey = `sebrae_stats_${this.state.currentUser}`;
            const stats = JSON.parse(localStorage.getItem(userKey) || '{"total":0, "hits":0}');
            stats.total += 1;
            if (isCorrect) stats.hits += 1;
            localStorage.setItem(userKey, JSON.stringify(stats));
        }
    },

    nextQuestion() {
        this.state.index++;
        if (this.state.index < this.state.currentItems.length) this.renderQuiz();
        else this.finishSession();
    },

    // Flashcards
    renderFlashcard() {
        const fc = this.state.currentItems[this.state.index];
        const total = this.state.currentItems.length;
        document.getElementById('fc-counter').innerText = `${this.state.index + 1}/${total}`;
        document.getElementById('fc-front').innerText = fc.frente;
        document.getElementById('fc-back').innerText = fc.verso;
        document.querySelector('.flashcard').classList.remove('flipped');
    },

    nextFlashcard() {
        this.state.index++;
        if (this.state.index < this.state.currentItems.length) this.renderFlashcard();
        else { alert("Fim dos flashcards!"); this.goHome(); }
    },

    // Utils
    finishSession() {
        const total = this.state.currentItems.length;
        const score = this.state.score;
        
        // As estat√≠sticas j√° foram salvas progressivamente no handlePostAnswer,
        // logo, n√£o precisamos adicionar tudo de novo aqui, apenas dar o feedback.

        alert(`Sess√£o finalizada!\nVoc√™ acertou ${score} de ${total}.`);
        this.goHome();
    },

    goHome() { this.updateStatsUI(); this.showScreen('screen-home'); },
    
    updateStatsUI() {
        if (!this.state.currentUser) return;
        
        // 1. Atualizar Score Global
        const userKey = `sebrae_stats_${this.state.currentUser}`;
        const stats = JSON.parse(localStorage.getItem(userKey) || '{"total":0, "hits":0}');
        document.getElementById('st-total').innerText = stats.total;
        const pct = stats.total === 0 ? 0 : Math.round((stats.hits / stats.total) * 100);
        document.getElementById('st-score').innerText = pct + '%';
        
        // 2. Atualizar Avisos de Revis√£o
        this.loadReviews();
        let pending = this.getPendingReviews();
        document.getElementById('st-reviews').innerText = pending.length;
        
        let btnRev = document.getElementById('btn-review-session');
        if(pending.length > 0) {
            btnRev.style.display = 'block';
            btnRev.innerText = `üîÑ Fazer ${pending.length} Revis√µes Pendentes`;
        } else {
            btnRev.style.display = 'none';
        }
    },
    
    resetStats() {
        if(confirm("Zerar TODAS as estat√≠sticas e fila de revis√£o deste utilizador?")) { 
            localStorage.removeItem(`sebrae_stats_${this.state.currentUser}`); 
            localStorage.removeItem(`sebrae_rev_${this.state.currentUser}`); 
            this.updateStatsUI(); 
        }
    },

    loadStats() { this.updateStatsUI(); },

    showScreen(id) {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        
        let status = 'In√≠cio';
        if(id === 'screen-setup') status = 'Carregando...';
        else if(id === 'screen-login') status = 'Login';
        else if(id.includes('quiz') || id.includes('flash')) status = 'Estudando';
        
        document.getElementById('header-status').innerText = status;
    }
};

app.init();
</script>
</body>
</html>
